{
  "hash": "f2aa29fff774fee637fea507ff3fed00",
  "result": {
    "markdown": "---\ntitle: \"Testing Evolution in Project TwinStick\"\nsubtitle: \"1 - The Evolution of Damage Resistance\"\ndescription: \"How can we encode a damage resistance game mechanic that interacts well with a generational model of evolution?\"\nauthor: \"Barrie D. Robison\"\ndate: \"August 9, 2023\"\ncode-fold: true  \ncode-tools: true\n---\n\n\nIs it really an *Evolutionary* game?\n\nWhen we are developing our games, we perform extensive testing to make sure the underlying biological models are performing as expected. In the case of evolutionary games, we need to test that the population of enemies is indeed adapting the game conditions as we intended. This post is (I hope) the first in a series in which we document those tests.\n\nMy hope is that performing these tests in this format will serve as an organized archive of our analyses, improving reproducibility and rigor. I also have a vain glimmer of hope that some person other than me might actually be interested in this topic.\n\n## PROJECT TWIN STICK\n\nThis is intended to be an evolutionary shooter. The game is described in detail [here](../Games/TwinStick/index.qmd).\n\n## DATA\n\nIn this section, we ingest the data from whatever runs are relevant to the analysis. The data are written from the project in `.csv` files. The following code reads all `.csv` files from the working directory. It creates new variables for the source file name (`file`) and the number of offspring produced by each individual (`offspring_count`). It then appends all the data files into a single data frame called `allfiles`. I also create a few aggregations of the data by generating mean values of interest (traits, genes, fitness estimates) for each generation in each file (`TraitAvg`, `GeneAvg`, `FitAvg`)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(pheatmap)\n\n\nfiles <- list.files(pattern = \"*.csv\", full.names = TRUE)\n\nallfiles = data.frame()\nfor(csv in files){\n  Twin3 <- read.csv(csv, as.is=T, header=T)\n  Twin3['file'] = csv\n\n\nTwin3<-Twin3%>%\n  mutate(Unique.Slime.ID = paste(Wave.Number, \".\", Slime.ID))%>%\n  mutate(Unique.Parent.One = paste(Wave.Number-1, \".\", Parent.One))%>%\n  mutate(Unique.Parent.Two = paste(Wave.Number-1, \".\", Parent.Two))\n\n\ndf_parents <- Twin3 %>%\n  select(Unique.Parent.One, Unique.Parent.Two) %>%\n  pivot_longer(cols = everything(), names_to = \"parent_type\", values_to = \"parent_id\")\n\n# Count the number of offspring for each parent\noffspring_counts <- df_parents %>%\n  group_by(parent_id) %>%\n  summarise(offspring_count = n(), .groups = \"drop\")\n\noffspring_counts <- offspring_counts%>%\n  filter(parent_id != \"-1 . N/A\")\n\n\noffspring_counts<- rename(offspring_counts, Unique.Slime.ID = parent_id)\n\n\n\nTwin3 <- Twin3 %>%\n  left_join(offspring_counts, by = \"Unique.Slime.ID\")%>%\n  replace_na(list(offspring_count = 0))\n\nallfiles<-rbind(allfiles,Twin3)\n\n}\n\n\n\nTraits <- c(\"Main.Resistance.Trait\", \"Secondary.Resistance.Trait\", \"Speed.Trait\",\n           \"Tower.Attraction.Trait\", \"Slime.Optimal.Distance.Trait\", \"Turn.Rate.Trait\", \n           \"Slime.View.Range.Trait\", \"Tower.View.Range.Trait\")\n\nGenes <- c(\"Main.Resistance.Gene\", \"Secondary.Resistance.Gene\", \"Speed.Gene\",\n           \"Tower.Attraction.Gene\", \"Slime.Optimal.Distance.Gene\", \"Turn.Rate.Gene\", \n           \"Slime.View.Range.Gene\", \"Tower.View.Range.Gene\")\n\nallfiles<-allfiles%>%\n  mutate(Generation=as.factor(Wave.Number))%>%\n  mutate(offspring.count.Fitness = offspring_count)%>%\n  mutate(reproduce = if_else(offspring_count == 0, \"N\", \"Y\"))\n   \n\nTraitAvg <- allfiles %>%\n  group_by(file, Generation) %>%\n  summarize(across(ends_with(\"Trait\"), mean,  na.rm = TRUE))\n\nGeneAvg <- allfiles %>%\n  group_by(file, Generation) %>%\n  summarize(across(ends_with(\"Gene\"), list(mean = mean, var = var), na.rm = TRUE, .names = \"{.fn}.{.col}\"))\n\nFitAvg <- allfiles %>%\n  group_by(file, Generation) %>%\n  summarize(across(ends_with(\"Fitness\"), list(mean = mean, var = var), na.rm = TRUE, .names = \"{.fn}.{.col}\"))\n```\n:::\n\n\nThe `allfiles` dataframe contains the following variables (I also show a few columns of the example data):\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.dictionary <- t(as.data.frame(head(allfiles)))\nknitr::kable(data.dictionary)\n```\n\n::: {.cell-output-display}\n|                             |1                                      |2                                      |3                                      |4                                      |5                                      |6                                      |\n|:----------------------------|:--------------------------------------|:--------------------------------------|:--------------------------------------|:--------------------------------------|:--------------------------------------|:--------------------------------------|\n|Slime.ID                     |0                                      |1                                      |2                                      |3                                      |4                                      |5                                      |\n|Wave.Number                  |0                                      |0                                      |0                                      |0                                      |0                                      |0                                      |\n|Path.Distance.To.Player      |11.578880                              |9.865794                               |11.072530                              |8.656490                               |12.428300                              |12.332610                              |\n|Player.Distance.Fitness      |3974.917                               |4601.597                               |4141.634                               |5177.865                               |3723.478                               |3750.202                               |\n|Parent.One                   |N/A                                    |N/A                                    |N/A                                    |N/A                                    |N/A                                    |N/A                                    |\n|Parent.Two                   |N/A                                    |N/A                                    |N/A                                    |N/A                                    |N/A                                    |N/A                                    |\n|Main.Type                    |Fire                                   |Laser                                  |Lightning                              |Fire                                   |Laser                                  |Blaster                                |\n|Secondary.Type               |Lightning                              |Ice                                    |Fire                                   |Laser                                  |Fire                                   |Ice                                    |\n|Main.Resistance.Gene         |2.060887                               |1.567136                               |0.538767                               |-1.465660                              |4.846877                               |1.900932                               |\n|Main.Resistance.Trait        |0.5781593                              |0.5477995                              |0.4836787                              |0.3620645                              |0.7333565                              |0.5683771                              |\n|Secondary.Resistance.Gene    |0.01938968                             |-0.25444700                            |-3.73592900                            |1.81140400                             |0.34911740                             |-0.43072260                            |\n|Secondary.Resistance.Trait   |0.18314960                             |0.17312900                             |0.08061782                             |0.25977300                             |0.19580530                             |0.16691090                             |\n|Slime.View.Range.Gene        |1.4521710                              |-1.3032780                             |-0.8455277                             |1.1033670                              |-2.8070340                             |-0.5393281                             |\n|Slime.View.Range.Trait       |9.846652                               |7.288872                               |7.710257                               |9.527897                               |5.971337                               |7.995144                               |\n|Tower.View.Range.Gene        |0.7422258                              |-1.4057490                             |-0.5228980                             |0.2925837                              |-3.1005300                             |-0.1302060                             |\n|Tower.View.Range.Trait       |22.85026                               |17.52136                               |19.69461                               |21.73113                               |13.61480                               |20.67451                               |\n|Player.View.Range.Gene       |-0.7063282                             |1.1152780                              |-0.6345016                             |1.2877800                              |-0.4439387                             |0.6586446                              |\n|Player.View.Range.Trait      |3.356673                               |4.271331                               |3.389172                               |4.366956                               |3.476874                               |4.025174                               |\n|Wall.View.Range.Gene         |0.13138430                             |1.63479000                             |1.03197000                             |2.12256400                             |0.06305833                             |1.54371300                             |\n|Wall.View.Range.Trait        |5.131722                               |6.345041                               |5.838480                               |6.771520                               |5.080783                               |6.266964                               |\n|Sheep.View.Range.Gene        |1.7711210                              |-1.7662380                             |0.8589699                              |1.0857650                              |0.7905225                              |1.7732480                              |\n|Sheep.View.Range.Trait       |6.462865                               |3.869560                               |5.697818                               |5.882667                               |5.642784                               |6.464712                               |\n|Slime.Attraction.Gene        |-0.97361480                            |2.85983300                             |-0.00132436                            |1.41690400                             |2.96294500                             |0.60026410                             |\n|Slime.Attraction.Trait       |0.4394477                              |0.6714959                              |0.4999172                              |0.5876420                              |0.6771568                              |0.5374463                              |\n|Tower.Attraction.Gene        |-0.4425031                             |-2.3597370                             |-1.6222210                             |1.6432250                              |-5.8312040                             |0.7847461                              |\n|Tower.Attraction.Trait       |-0.29616710                            |-0.49673860                            |-0.42417950                            |-0.04456747                            |-0.75258950                            |-0.15074900                            |\n|Player.Attraction.Gene       |-0.6821441                             |0.7002198                              |-0.3265617                             |3.7018040                              |-1.6177000                             |0.2446628                              |\n|Player.Attraction.Trait      |0.01473093                             |0.18535970                             |0.05911088                             |0.50999690                             |-0.10185810                            |0.12984560                             |\n|Wall.Attraction.Gene         |0.1195688                              |-0.1511556                             |-2.9512140                             |3.4388130                              |3.0539160                              |0.5988827                              |\n|Wall.Attraction.Trait        |-0.8776227                             |-0.8847079                             |-0.9392208                             |-0.7577341                             |-0.7749578                             |-0.8641599                             |\n|Sheep.Attraction.Gene        |0.8572116                              |-1.5254840                             |-0.7902940                             |-0.7743754                             |-0.2995906                             |-1.1352990                             |\n|Sheep.Attraction.Trait       |0.7710594                              |0.6499067                              |0.6904933                              |0.6913431                              |0.7160806                              |0.6717642                              |\n|Slime.Optimal.Distance.Gene  |0.2664202                              |3.6042880                              |-1.0556060                             |0.8011839                              |0.4063749                              |1.7429750                              |\n|Slime.Optimal.Distance.Trait |0.2759589                              |0.6047078                              |0.1175039                              |0.3365067                              |0.2920418                              |0.4364783                              |\n|Speed.Gene                   |2.6708090                              |2.7693390                              |1.7675290                              |1.2229970                              |0.9674612                              |-3.1236780                             |\n|Speed.Trait                  |3.594294                               |3.638617                               |3.201688                               |2.978000                               |2.876638                               |1.588666                               |\n|Turn.Rate.Gene               |-2.003947000                           |-0.003989722                           |2.665061000                            |-0.611806700                           |-0.087987470                           |0.942467800                            |\n|Turn.Rate.Trait              |0.1190994                              |0.1822768                              |0.3028560                              |0.1607104                              |0.1791677                              |0.2202203                              |\n|Sprint.Duration.Gene         |0.3580502                              |-0.3317875                             |-0.3822251                             |-0.3363649                             |0.5547686                              |0.4983550                              |\n|Sprint.Duration.Trait        |2.611816                               |2.396376                               |2.380646                               |2.394948                               |2.673088                               |2.655535                               |\n|Sprint.Cooldown.Gene         |0.17904180                             |1.97089800                             |0.69569630                             |-0.44410650                            |1.28146400                             |0.03339072                             |\n|Sprint.Cooldown.Trait        |2.723206                               |4.388537                               |3.336164                               |1.953815                               |3.913494                               |2.541734                               |\n|X                            |NA                                     |NA                                     |NA                                     |NA                                     |NA                                     |NA                                     |\n|file                         |./geneWriteFile08_10_2023_13-47-10.csv |./geneWriteFile08_10_2023_13-47-10.csv |./geneWriteFile08_10_2023_13-47-10.csv |./geneWriteFile08_10_2023_13-47-10.csv |./geneWriteFile08_10_2023_13-47-10.csv |./geneWriteFile08_10_2023_13-47-10.csv |\n|Unique.Slime.ID              |0 . 0                                  |0 . 1                                  |0 . 2                                  |0 . 3                                  |0 . 4                                  |0 . 5                                  |\n|Unique.Parent.One            |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |\n|Unique.Parent.Two            |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |-1 . N/A                               |\n|offspring_count              |0                                      |0                                      |0                                      |0                                      |0                                      |0                                      |\n|Generation                   |0                                      |0                                      |0                                      |0                                      |0                                      |0                                      |\n|offspring.count.Fitness      |0                                      |0                                      |0                                      |0                                      |0                                      |0                                      |\n|reproduce                    |N                                      |N                                      |N                                      |N                                      |N                                      |N                                      |\n:::\n:::\n\n\nVariables that end in `.Gene` are the values of the genome for that particular locus. Variables that end in `.Trait` are the values of the trait for that particular locus. Variables that end in `.Fitness` are the values of that particular Fitness component.\n\n## EXPERIMENTAL CONDITIONS\n\nThe enemies in this game are slimes of several different types. These types correspond to the different damage types that can be caused by the player's towers (Lightning, Ice, Fire, etc). Our initial idea is that the slimes of a specific type should be resistant to that type of damage. The average resistance of the whole population should increase over time if the player relies on only one type of tower.\n\nThe current resistance model is as follows:\n\nDamage Resistance = (Main.Type)0.6 + (Secondary.Type)0.4\n\nWhere Main.Type and Secondary.Type = 1 if they match the Damage Type and 0 if they do not.\n\nOur hypothesis is that resistance of the population will adapt to the damage type of the defense used. If true, this hypothesis predicts that the mean resistance of the population will increase over time, primarily through the proliferation of slimes of a Type that matches the Damage Type.\n\nWe constructed a simple defense in the center of the playing area, consisting of three lightning towers. The only Fitness Function at this time is related to Path Distance to the Player (the closer they get to the player, the more fitness they acquire).\n\n## RESULTS\n\n### Slime Types\n\nEach Slime has a `Main.Type` and a `Secondary.Type`. These types use the `~.Resistance.~` category to confer resistance to the appropriate damage type.\n\nThe following code creates two summary dataframes with the suffix `~Typecounts` that count the number of slimes of each `~.Type` in each generation for each replicate. It then creates the graphs of `~Type` frequency over time.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nMainTypecounts <- allfiles %>%\n  group_by(Main.Type, Generation, file) %>%\n  summarise(Main.count = n(), .groups = \"drop\")\n\nSecondaryTypecounts <- allfiles %>%\n  group_by(Secondary.Type, Generation, file) %>%\n  summarise(Secondary.count = n(), .groups = \"drop\")\n\n            \n\nggplot(MainTypecounts, aes(x = Generation, y = Main.count, fill = as.factor(Main.Type))) +\n  geom_col(position = \"stack\") +\n  labs(x = \"Generation\", y = \"Count\", fill = \"Main Slime Type\") +\n  theme_minimal()+\n  facet_wrap(~file, ncol=2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(SecondaryTypecounts, aes(x = Generation, y = Secondary.count, fill = as.factor(Secondary.Type))) +\n  geom_col(position = \"stack\") +\n  labs(x = \"Generation\", y = \"Count\", fill = \"Secondary Slime Type\") +\n  theme_minimal()+\n  facet_wrap(~file, ncol=2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n:::\n\n\nThese results align with the predictions of our hypothesis. There is an obvious proliferation of Lightning type slimes (both Main and Secondary) in all 6 replicates.\n\n## Slime Fitness\n\nIn most cases, it is useful to summarize the behavior of the fitness function for each experiment. In this case, the fitness function calculates a value of 50,000/(distance to player +1). I will also reverse calculate that for visualization, showing the actual distance to the player (`Path.Distance.To.Player`). We then use Roulette Wheel selection to determine the parents of the next generation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(allfiles, aes(x=Wave.Number, y= Path.Distance.To.Player))+\n  geom_jitter(aes(x=Wave.Number, y= Path.Distance.To.Player, color = offspring_count, alpha = offspring_count))+\n  geom_smooth()+\n  facet_wrap(~file, ncol = 2)+\n  scale_color_continuous(low=\"blue\", high = \"red\")+\n  ylim(0, 80)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 1 rows containing non-finite values (`stat_smooth()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Computation failed in `stat_smooth()`\nCaused by error in `smooth.construct.cr.smooth.spec()`:\n! x has insufficient unique values to support 10 knots: reduce k.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 1469 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 4 rows containing missing values (`geom_smooth()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nThis is a jitter plot, which helps prevent overplotting of all the points.  The Y axis appears to be messed up because there was one slime in one replicate that died very far away from the player (value of 300).  I've limited the axis to make the plots more readable.  There is also a bug that sets the path distance to 0 in generation 0, and Justin is working on that.\n\nIn a plot like this, we expect to see that points closer to 0 on the y axis are more opaque and red, indicating that those individuals had more offspring.  Looks pretty good in that regard.  We also note that there are obviously two groups of slimes - one that dies far away and one that gets pretty close.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(allfiles, aes(x=Wave.Number, y= log10(Player.Distance.Fitness)))+\n  geom_jitter(aes(x=Wave.Number, y= log10(Player.Distance.Fitness), color = offspring_count, alpha = offspring_count))+\n  geom_smooth()+\n  facet_wrap(~file, ncol = 2)+\n  scale_color_continuous(low=\"blue\", high = \"red\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = \"cs\")'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Computation failed in `stat_smooth()`\nCaused by error in `smooth.construct.cr.smooth.spec()`:\n! x has insufficient unique values to support 10 knots: reduce k.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nThis plot is the same general concept as the previous one, but I am using the transformed values for fitness.  I've log transformed because of the distribution created by the transformation (something we'll have to address in development I think).  In this case, points near the top should be more red if the fitness function is working.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(allfiles, aes(x=Path.Distance.To.Player, y = Player.Distance.Fitness))+\n  geom_point(aes(x=Path.Distance.To.Player, y = Player.Distance.Fitness, color = offspring_count),  alpha = 0.5)+\n  facet_wrap(~file, ncol = 2)+\n  scale_color_continuous(low=\"blue\", high = \"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nThis is the relationship between true path distance and transformed values.  I think this is going to be a problem.  The function creates a weird distribution for fitness values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(allfiles, aes(x=log10(Path.Distance.To.Player), y = log10(Player.Distance.Fitness)))+\n  geom_point(aes(x=log10(Path.Distance.To.Player), y = log10(Player.Distance.Fitness), color = offspring_count),  alpha = 0.5)+\n  facet_wrap(~file, ncol = 2)+\n  scale_color_continuous(low=\"blue\", high = \"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\nThis is the log plot of the two variables, which suggests we might consider using log10(Fitness) during the selection step?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = FitAvg, aes(x = Generation, y = var.offspring.count.Fitness))+\n    geom_col()+\n    theme(legend.position = \"none\") +\n    facet_wrap(~file, ncol = 2) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(allfiles, aes(x = as.factor(Wave.Number), y = log10(offspring_count+1))) + \n  geom_boxplot(fill=\"lightblue\") +\n  theme(legend.position = \"none\")+\n  facet_wrap(~file, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\nThese two plots help us understand the relationship between the fitness function and the TRUE measure of fitness - number of offpring.  The first plot shows us the variance in `offspring_count` for each Generation.  High variance indicates that not all individuals have an equal probability of mating, which is indicative that selection is acting on the population.\n\nThe second plot is a box plot of `offspring_count` by Generation, which gives us an idea of what the distribution looks like.\n\nOverall, I'd say these game conditions create selection in the early game, between Generation 1 and 3.  The question is, what TRAITS are associated with this variation in Fitness?\n\n## Evolutionary Responses\n\nTo estimate what traits might be under selection, we can calculate selection gradients for each trait.  This is essentially the slope of the line between `offspring_count` and the Trait.\n\nFor each Trait, we should also try to understand its individual evolutionary trajectory.  Is the population mean for the trait increasing or decreasing?\n\nSince the first thing we are interested in is Damage Resistance conferred by Type, we'll calculate Lightning resistance directly.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nallfiles <- allfiles %>%\n  mutate(LResist.Trait = case_when(\n    Main.Type == \"Lightning\" & Secondary.Type == \"Lightning\" ~ 1.0,\n    Main.Type == \"Lightning\" & Secondary.Type != \"Lightning\" ~ 0.6,\n    Main.Type != \"Lightning\" & Secondary.Type == \"Lightning\" ~ 0.4,\n    TRUE ~ 0\n  ))\n\ntraittemp <- allfiles %>%\n  select(Generation, offspring_count, file, LResist.Trait) %>%\n  group_by(Generation, file) %>%\n  mutate(scaleST0 = as.vector(scale(LResist.Trait, center = TRUE))) %>%\n  mutate(scaleST02 = scaleST0 * scaleST0) %>%\n  mutate(Generation = as.numeric(as.character(Generation)))\n\n\n\n\nGradients <- traittemp %>%\n  group_by(Generation, file) %>%\n  do({\n    model <- lm(offspring_count ~ scaleST0 + scaleST02, data = .)\n    data.frame(\n      Beta = coefficients(model)[2],\n      PB = summary(model)$coef[2, 4],\n      Trait = \"LResist.Trait\"\n    )\n  })\n\nGradients <- Gradients %>%\n  mutate(sig = if_else(PB < 0.05 , \"Y\", \"N\"))\n\nTraitAvg <- allfiles %>%\n  group_by(file, Generation) %>%\n  summarize(across(ends_with(\"Trait\"), mean,  na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'file'. You can override using the\n`.groups` argument.\n```\n:::\n\n```{.r .cell-code}\nggplot(data = TraitAvg, aes(x = as.numeric(Generation), y = LResist.Trait))+\n    geom_smooth(data = TraitAvg, aes(x = as.numeric(Generation), y = LResist.Trait), method = \"loess\") +\n    theme(legend.position = \"none\") +\n    facet_wrap(~file, ncol = 2) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(Gradients, aes(x=Generation, y = Beta))+\n  geom_point(aes(color = sig))+\n  geom_smooth(fill=\"blue\")+\n  scale_color_manual(values = c(\"grey\",\"red\"))+\n  geom_hline(yintercept=0, linetype=\"dashed\", color = \"black\")+\n  theme(legend.position = \"none\",\n        panel.background = element_blank())\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-2.png){width=672}\n:::\n:::\n\n\n\nNow we'll perform a similar analysis for the remaining traits.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nGradientslong <- data.frame()\nfor(i in seq_along(Traits)){\n\ntraittemp<-allfiles%>%\n  select(Generation, offspring_count, file, !!sym(Traits[i]))%>%\n  group_by(Generation, file)%>%\n  mutate(scaleST0 = as.vector(scale(!!sym(Traits[i]), center = TRUE)))%>%\n  mutate(scaleST02 = scaleST0*scaleST0)%>%\n  mutate(Generation = as.numeric(as.character(Generation)))\n\nGradients <- traittemp %>%\n  group_by(Generation, file) %>%\n  do({\n    model <- lm(offspring_count ~ scaleST0 + scaleST02, data = .)\n    data.frame(\n      Beta = coefficients(model)[2],\n      PB = summary(model)$coef[2, 4],\n      Trait = Traits[i]\n    )\n  })\n\nGradients <- Gradients %>%\n  mutate(sig = if_else(PB < 0.05 , \"Y\", \"N\"))\n\nGradientslong <- rbind(Gradientslong, Gradients)\n\nG <- ggplot(data = GeneAvg, aes(x = as.numeric(Generation), y = !!sym(Genes[i])))+\n    geom_point(data = allfiles, aes(x = as.numeric(Generation), y = !!sym(Genes[i])), size=0.1, alpha = 0.02)+\n    geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y = !!sym(paste(\"mean.\",Genes[i], sep = \"\")), method = \"loess\")) +\n    theme(legend.position = \"none\") +\n    facet_wrap(~file, ncol = 2) \n\nP <- ggplot(data = TraitAvg, aes(x = as.numeric(Generation), y = !!sym(Traits[i])))+\n    geom_smooth(data = TraitAvg, aes(x = as.numeric(Generation), y = !!sym(Traits[i])), method = \"loess\") +\n    geom_point(data=allfiles, aes(x = as.numeric(Generation), y = !!sym(Traits[i]), color = offspring_count), size = 0.5, alpha =0.1)+\n    theme(legend.position = \"none\") +\n    facet_wrap(~file, ncol = 2) \n\n\n\nS <- ggplot(Gradients, aes(x=Generation, y = Beta))+\n  geom_point(aes(color = sig))+\n  geom_smooth(fill=\"blue\")+\n  scale_color_manual(values = c(\"grey\",\"red\"))+\n  geom_hline(yintercept=0, linetype=\"dashed\", color = \"black\")+\n  theme(legend.position = \"none\",\n        panel.background = element_blank())\n\nprint(G)\n\nprint(P)\n\nprint(S)\n\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-5.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-6.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-7.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-8.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-9.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-10.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-11.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-12.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-13.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-14.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-15.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-16.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-17.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-18.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-19.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-20.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in geom_smooth(data = GeneAvg, aes(x = as.numeric(Generation), y =\n!!sym(paste(\"mean.\", : Ignoring unknown aesthetics: method\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-21.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-22.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-23.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-24.png){width=672}\n:::\n:::\n\n\n## Heatmap\n\n\n::: {.cell}\n\n```{.r .cell-code}\nGradMatrix <- Gradientslong %>%\n  select(Generation, Trait, Beta)%>%\n  pivot_wider(names_from = Trait, values_from = Beta)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nAdding missing grouping variables: `file`\n```\n:::\n\n```{.r .cell-code}\npaletteLength <- 50\nmyColor <- colorRampPalette(c(\"blue\", \"white\", \"#ED2024\"))(paletteLength)\n# length(breaks) == length(paletteLength) + 1\n# use floor and ceiling to deal with even/odd length pallettelengths\n\n\nHeatmap <- GradMatrix %>%\n  ungroup()%>%\n  select(Main.Resistance.Trait, Secondary.Resistance.Trait, Slime.View.Range.Trait, \n         Tower.View.Range.Trait, \n         Tower.Attraction.Trait, Slime.Optimal.Distance.Trait, \n         Speed.Trait, Turn.Rate.Trait)\n\n\n\n\n\n\n\nHeatmatrix2 <- as.matrix(Heatmap)\n\nmyBreaks2 <- c(seq(min(Heatmatrix2), 0, length.out=ceiling(paletteLength/2) + 1), seq(max(Heatmatrix2)/paletteLength, max(Heatmatrix2), \n                                                                                      length.out=floor(paletteLength/2)))\n\n\nheatmap2 = pheatmap(Heatmatrix2,\n         cluster_rows = FALSE, # don't cluster rows\n         cluster_cols = TRUE, # don't cluster columns\n         clustering_distance_cols = \"euclidean\",\n         clustering_distance_rows = \"euclidean\",\n         clustering_method = \"complete\",\n         color = myColor,\n         breaks = myBreaks2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## SINGLE GENERATION PLOTS\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsinglegen <- allfiles %>%\n  filter(Generation == 5)\n\nsinglegrad <- Gradientslong %>%\n  filter(Generation == 3)\n\n\nggplot(singlegen, aes(x=Speed.Trait) )+\n  geom_histogram()+\n  facet_grid(reproduce~file)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(singlegen, aes(x=Turn.Rate.Trait) )+\n  geom_histogram()+\n  facet_grid(reproduce~file)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-2.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(singlegen, aes(x=Turn.Rate.Trait, y = Speed.Trait, color = reproduce))+\n  geom_point()+\n  facet_wrap(~file)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-3.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}